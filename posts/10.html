<!DOCTYPE html><html lang="en"><head><title>Finally: Data Structure Constants in Erlang</title><link rel="alternate" type="application/atom+xml" title="Atom feed" href="atom.xml"><meta name="viewport" content="width=device-width,initial-scale=1"><style>a,#p21{text-decoration:none}a:link{color:#00D}a:visited{color:purple}a:hover{text-decoration:underline}body,div{margin:0;padding:0;box-sizing:border-box}body{font:100%/1.5 verdana;color:#222}p,ul,blockquote,pre{margin:0 0 1em}ul{list-style:none;padding-left:1em;text-indent:-1em}h1,h2{font:700 1.27em verdana;margin:0 0 .5em}h1{color:#117}blockquote{font-style:italic}pre,code{font:700 1em "courier new",monospace}pre{overflow:auto}.box{margin:0 auto;padding:0 12px}.s{font:.91em/1.4 verdana}.ab a{display:block;margin:0 0 1em;padding-left:1em;text-indent:-1em}#top{background:#117;color:#FFF;margin:0 0 .67em;border:0 solid #7373D9;border-width:0 0 12px;padding:2em 0 0}#p21{font:700 2.5em georgia;color:#FFF}#perm{color:#222;background:#DDD;border:1px solid #BBB;padding:2px}@media screen and (min-width:768px){blockquote,pre{margin-left:1.25em}.box{max-width:840px}#c1{width:71%;float:left}#c2{width:26%;float:right}}</style></head><body><div id="top"><div class="box"><a id="p21" href="/">programming in&nbsp;the<br>twenty-first century</a><p>It's not about technology for its own sake. It's about being able to implement your ideas.</p></div></div><div class="box"><div id="c1"><h1>Finally: Data Structure Constants in Erlang</h1><p>Here's a simple Erlang function to enclose some text in a styled paragraph, returning a deep list:</p><pre>para(Text) -&gt;
   ["&lt;p class=\"normal\"&gt;", Text, "&lt;/p&gt;"].</pre><p>Prior to the new R12B release of Erlang, this little function had some less than ideal behavior.</p><p>Every time <code>para</code> was called, the two constant lists (a.k.a. strings) were <i>created</i>, which is to say that there weren't true data structure constants in Erlang.</p><p>Each string was built-up, letter by letter, via a series of BEAM virtual machine instructions.  The larger the constant, the more code there was to generate it, and the more time it took to generate.</p><p>Because a new version of each string was created for each <code>para</code> call, there was absolutely no sharing of data. If <code>para</code> was called 200 times, 400 strings were created (200 of each). Remember, too, that each element of a list/string in 32-bit Erlang is 8 bytes.  Doing the math on this example is mildly unsettling: 22 characters * 8 bytes per character * 200 instances = 35,200 bytes of "constant" string data.</p><p>As a result of more data being created, garbage collection occurred more frequently and took longer (because there was more live data).</p><p>Years ago, this problem was solved in HIPE, the standard native code compiler for Erlang, by putting constant data structures into a pool.  Rather than using BEAM instructions to build constants, each constant list or tuple or more complex structure is simply a pointer into the pool.  For some applications, such as turning a tree into HTML, the HIPE approach is a significant win.</p><p>And now, finally, as of the December 2007 R12B release, true data structure constants are supported in BEAM.</p><p class="s"><a href="10.html" id="perm">permalink</a> <i>December 9, 2007</i></p><h1>previously</h1><ul><li><a href=9.html>Two Stories of Simplicity</a><li><a href=8.html>Deriving Forth</a><li><a href=7.html>Trapped! Inside a Recursive Data Structure</a><li><a href=6.html>Sending Modern Languages Back to 1980s Game Programmers</a><li><a href=5.html>Erlang as a Target for Imperative DSLs</a></ul></div><div id="c2"><h1><a href="archives.html">archives</a></h1><p><b><a href="https://twitter.com/dadgumjames">twitter</a></b> / <b><a href="mailto:james.hague@gmail.com">mail</a></b></p><div class="s"><p>I'm James Hague, a <a href="56.html">recovering programmer</a> who has been designing video games since the 1980s. <a href="195.html">Programming Without Being Obsessed With Programming</a> and <a href="177.html">Organizational Skills Beat Algorithmic Wizardry</a> are good starting points. For the older stuff, try the <a href="162.html">2012 Retrospective</a>.</p><p>Where are <a href="57.html">the comments</a>?</p></div></div></div>